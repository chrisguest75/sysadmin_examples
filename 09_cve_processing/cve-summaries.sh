#!/usr/bin/env bash 
#Use !/bin/bash -x  for debugging 

readonly SCRIPT_NAME=$(basename "$0")
readonly SCRIPT_PATH=${0:A}
readonly SCRIPT_DIR=$(dirname "$SCRIPT_PATH")

#****************************************************************************
#** Print out usage
#****************************************************************************

function help() {
    local EXITCODE=0

    cat <<- EOF
usage: $SCRIPT_NAME options

Program lists out summaries of CVEs.

OPTIONS:
    -a --action              [cve]
    -f --file                File containing list of CVEs
    
    -h --help                show this help

Examples:
    :
    $SCRIPT_NAME --file=cve.txt --action=cve > dev-vulns.txt

EOF

    return ${EXITCODE}
}

#****************************************************************************
#** Main script 
#****************************************************************************

function main() {
    local EXITCODE=0

    for i in "$@"
    do
    case $i in
        -a=*|--action=*)
            local -r ACTION="${i#*=}"
            shift # past argument=value
        ;;    
        -f=*|--filter=*)
            local -r FILTER="${i#*=}"
            shift # past argument=value
        ;;
        -f=*|--file=*)
            local -r FILE="${i#*=}"
            shift # past argument=value
        ;;      
        #-i|--ignoreerror)
        #    local -r IGNOREERRORS=true
        #    shift # past argument=value
        #;;
        -h|--help)
            local -r HELP=true            
            shift # past argument=value
        ;;
        *)
            echo "Unrecognised ${i}"
        ;;
    esac
    done    

    if [ "${HELP}" = true ] ; then
        EXITCODE=1
        help
    else
        if [ "${ACTION}" ]; then
            case "${ACTION}" in
                help)
                    help
                ;;
                cve)
                    while read cve; do
                        #echo "CVE $cve"; 
                        cvedoc=$(curl -s -L http://cve.circl.lu/api/cve/${cve})
                        cveinfo=$(echo ${cvedoc} | jq --raw-output '. | "\(.id) \(.access.complexity) - \(.summary)"')
                        echo "$cveinfo http://cve.circl.lu/api/cve/${cve}";                                 
                    done < ${FILE}
                ;;
                *)
                    echo "Unrecognised ${ACTION}"; 
                ;;
            esac
        else
            EXITCODE=1
            echo "No action specified use --action=<action>"
        fi
    fi
    return ${EXITCODE}
}

main "$@"



